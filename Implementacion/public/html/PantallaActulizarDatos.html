<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PantallaActualizarDatos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="../styles/PantallaActulizarDatosStyle.css">
</head>
<body>

    <style>
        
        .col-12.center-items {
        position: relative;
    }

    .error-container {
        display: block;
        margin-top: 2.5px;
    }

    .error-message {
        color: red;
        font-size: 12px;
        font-weight: bold;
    }
    .error-message-titulo {
        color: red;
        font-size: 20px;
        font-weight: bold;
    }
    </style>
    <header>
        <nav class="navbar navbar-expand-lg navColor">
            <div class="container-fluid">
                <div class="col-3 regresar">
                    <a href="/turistas/perfil"><img src="../imgs/imgActualizarDatos/image 29.png"></a>
                </div>
                <div class="col-6 titulo">
                    Actualizar Datos
                </div>
                <div class="col-3 inicio">
                    <a href="/turistas/mapa"><img src="../imgs/imgActualizarDatos/image 30.png"></a>
                </div>
            </div> 
        </nav>
    </header>
    
    <div class="container-fluid">
        <div class="row">
                <div class="col-12 foto">
                    <img id="view-new-upload-image" src="../imgs/imgActualizarDatos/Ellipse 3.png">
                </div>
                <form id="form-actualizar-datos" enctype="multipart/form-data">
                    <div class="col-12 center-items subirImg">
                        <img id="profile-image" src="../imgs/imgActualizarDatos/Agregar.png">
                        <label id="btn-open-file-selector">Cambiar Foto</label>
                        <input type="file" accept="image/*" name="avatar" id="avatar" onchange="cambiarImagen(event)" />
                    </div>
                </form>

                <form method="PATCH" id="updateForm">
                    <div class="dtsActualizar">
                        <div class="col-12 center-items">                           
                            <input name="Nombre" type="text" placeholder="Nombre de usuario" id="Usuario" class="form-control" onchange="validarUsuario()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="2.25rem" height="2.25rem" fill="currentColor" id="svg1" class="bi bi-pencil-square" viewBox="0 0 16 16" onclick="enabledNombre()">
                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                            </svg>
                        </div>
                        <div class="col-12 center-items botones">
                            <span id="Usuario-error" class="error-message"></span>
                        </div>  
                        <div class="col-12 center-items">
                            <input name="Telefono" type="tel" placeholder="Telefono" id="telefono" class="form-control" onchange="validarTelefono()" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="2.25rem" height="2.25rem" fill="currentColor" id="svg2" class="bi bi-pencil-square" viewBox="0 0 16 16" onclick="enabledTelefono()">
                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                            </svg>
                        </div>

                        <div class="col-12 center-items botones">
                            <span id="telefono-error" class="error-message"></span>
                        </div>                        

                        <div class="col-12 center-items">
                            <input name="contrasena" type="text" placeholder="Nueva contraseña" id="newPassword" class="form-control" onchange="validarContraseña()" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="2.25rem" height="2.25rem" fill="currentColor" id="svg3" class="bi bi-pencil-square" viewBox="0 0 16 16" onclick="enabledNuevaContraseña()">
                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                            </svg>
                            
                        </div>
                        <div class="col-12 center-items botones">
                            <span id="newPassword-error" class="error-message"></span>
                        </div>
                        
                        <div class="col-12 center-items">
                            <input name="confirmarContrasena" type="text" placeholder="Confirmar contraseña" id="confirmPass" oninput="validarContraseñas()" class="form-control edit" disabled>
                        </div>
                        <div style="text-align: center;" id="mensajeContraseñas"></div><br>
                    </div> 
                    <div class="botones">
                        <div class="col-12 center-items">
                            <!-- <input type="button" value="Volver a mi perfil" id="" onclick="location.href='../html/PantallPerfil.html'"> -->
                            <input type="button" value="Preferencias" id="" onclick="location.href='/turistas/preferencias2'">
                            <input type="button" value="Guardar" id="guardar" data-bs-toggle="modal" data-bs-target="#modalGuardar">
                        </div>
                        
                    </div>
                    <div class="botones">
                        <div class="col-12 center-items">
                            
                            <input type="button" value="Eliminar cuenta" id="" data-bs-toggle="modal" data-bs-target="#modalEliminarCuenta">
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!--Ventana de confirmacion para guardar-->
        <div class="modal fade " id="modalGuardar" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <p>¿Está seguro de guardar los datos?</p>
                        <div class="center-items">
                            <button type="button" class="btn btn-primary iconConfirm" id="confirmGuardarDatos" onclick="mostrarModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="25" fill="green" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                              </svg>Confirmar</button><!--aqui se guarda la info-->
                        </div>
                        <div class="center-items">
                            <button type="button" class="btn btn-secondary iconCancel" data-bs-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="25" fill="red" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
                              </svg>Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div> 

        <!--Ventana de aviso de datos guardados-->
        <div class="modal fade" id="modalConfirm" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <p>Datos guardados</p>
                        <div class="center-items">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continuar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div> 

         <!--Ventana de error en los datos a guardar-->
         <div class="modal fade" id="modalConfirm2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <p>Completa correctamente los campos</p>
                        <div class="center-items">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continuar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div> 

        <!--Ventana de eliminación de cuenta-->
        <div class="modal fade " id="modalEliminarCuenta" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <p>¿Está seguro de eliminar su cuenta?</p>
                        <div class="center-items">
                            <button type="button" class="btn btn-primary iconConfirm2" id="confirmEliminarCuenta" onclick="eliminarCuenta()"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="25" fill="green" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                              </svg>Confirmar eliminación</button><!--aqui se guarda la info-->
                        </div>
                        <div class="center-items">
                            <button type="button" class="btn btn-secondary iconCancel" data-bs-dismiss="modal"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="25" fill="red" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
                              </svg>Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
    </div> 
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  
    <script>
        async function eliminarCuenta() {
            try {
                const response = await fetch('/turistas/eliminar', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if(response.ok){
                    Swal.fire({
                        icon: 'success',
                        title: 'Cuenta eliminada exitosamente',
                    }).then(() => {
                        window.location.href = '/turistas'; 
                    });
                }

            } catch (error) {
                console.error('Error en la conexión con la base de datos:', error);
            }
        };

        function updateData() {
    // Obtén el formulario
    const form = document.getElementById('updateForm');

    // Crea un objeto FormData para recopilar los datos del formulario
    const formData = new FormData(form);

    // Convierte FormData a un objeto JSON
    const jsonData = {};
    formData.forEach((value, key) => {
        jsonData[key] = value;
    });
    console.log('Datos a enviar:', jsonData);


    // Realiza una solicitud PATCH usando fetch
    fetch('/turistas/actdatos', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json', // Especifica el tipo de contenido JSON
        },
        body: JSON.stringify(jsonData),
    })
    .then(response => {
        // Manejar la respuesta del servidor
        if (response.ok) {
            console.log('Datos actualizados correctamente');
            // Aquí puedes redirigir a otra página o realizar otras acciones
        } else {
            console.error('Error al actualizar datos');
        }
    })
    .catch(error => {
        // Manejar errores de red u otros errores
        console.error('Error de red:', error);
    });
}



    </script>    
  
    <script>
    /*Función que valida el campo de Teléfono para que solo acepte números y máximo 10*/
    function validarTelefono() {
        var telefonoInput = document.getElementById("telefono");
        var telefonoValor = telefonoInput.value.trim();
        var numerosRegex = /^\d+$/;

        if(telefonoValor === ''){
            ocultarError("telefono")
            return true
        }
        else if (!numerosRegex.test(telefonoValor)) {
            mostrarError("telefono", "El teléfono solo debe contener números.<br><br>");
            return false;
        } else if (telefonoValor.length != 10) {
            mostrarError("telefono", "El teléfono debe tener 10 dígitos.<br><br>");
            return false;
        } else {
            ocultarError("telefono");
            return true;
        }
    }

    function validarContraseñas() {
            var password = document.getElementById('newPassword').value;
            var confirmPassword = document.getElementById('confirmPass').value;
            var mensaje = document.getElementById('mensajeContraseñas');
            var botonRegistro = document.getElementById('guardar');

            if (password === confirmPassword) {
                mensaje.innerHTML = 'Las contraseñas coinciden';
                mensaje.style.color = 'green';
                botonRegistro.disabled = false; // Habilitar el botón
                return true;
            } else {
                mensaje.innerHTML = 'Las contraseñas no coinciden';
                mensaje.style.color = 'red';
                botonRegistro.disabled = true; // Deshabilitar el botón
                return false;
            }
        }

        //Función para validar el campo de Contraseña
        function validarContraseña() {
            let ContraseñaInput = document.getElementById("newPassword");
            let ContraseñaValor = ContraseñaInput.value.trim();
            let ContraseñaRegex = /^(?=.*[A-Z])(?=.*[-@*]).+$/;

            if(ContraseñaValor=== ""){
                ocultarError("newPassword")
                return true;
            }
            else if (!ContraseñaRegex.test(ContraseñaValor)) {
                mostrarError("newPassword", "La contraseña debe contener:<br>- Al menos una mayúscula <br>- Al menos un caracter especial (*, @, -)<br>-Debe ser entre 8 y 12 caracteres<br><br>");
                return false;
            } else if (ContraseñaValor.length < 8 || ContraseñaValor.length > 12) {
                mostrarError("newPassword", "Debe ser entre 8 y 12 caracteres. <br><br>");
                return false;
            } else {
                ocultarError("newPassword");
                return true;
            }
        }
        /*Función que valida el input de Usuario que solo tenga letras o espacio en blanco */
        function validarUsuario() {
        var usuarioInput = document.getElementById("Usuario");
        var usuarioValor = usuarioInput.value.trim();
        var letrasRegex = /^[\w_]+$/;

        if(usuarioValor === ''){
            ocultarError("Usuario")
            return true;
        }
        else if (!letrasRegex.test(usuarioValor)) {
            mostrarError("Usuario", "Ingresar solo letras, números o caracter especial (_).<br><br>");
            return false;
        } else {
            ocultarError("Usuario");
            return true;
        }
        }

        /*Función que hace aparecer el mensaje de Error en los Inputs del formulario a los que se le haya ingresado un valor no válido */
        function mostrarError(elementId, message) {
        var errorElement = document.getElementById(elementId + "-error");
        errorElement.innerHTML = message;
        }

        /*Función que oculta el mensaje de Error de la anterior función */
        function ocultarError(elementId) {
        var errorElement = document.getElementById(elementId + "-error");
        errorElement.innerHTML = "";
        }

        async function validarDatos(){
            var TelefonoValido = validarTelefono();
            var ContraseñaValida = validarContraseña();
            var ContraseñasIguales = validarContraseñas();
            var UsuarioValido = validarUsuario();

            if(TelefonoValido && ContraseñaValida && ContraseñasIguales && UsuarioValido){
                try {
                    const usuarioInput = document.getElementById('Usuario');
                    const valorUsuario = usuarioInput.value;
                
                    const response = await fetch('/turistas/usuario', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                        Usuario: valorUsuario
                        }),
                    });

                    const data = await response.json();

                    if (data.exists) {
                        // Verificar si el usuarioya está en uso
                        if (data.type === 'usuario') {
                            Swal.fire({
                                    icon: 'error',
                                    title: "Nombre de usuario en uso",
                                });
                                
                        } 
                    } else {
                        updateData()
                        return true
                    }
                    } catch (error) {
                        console.error('Error al realizar la solicitud fetch:', error);
                        return false;
                    }
            }else{
                return false
            }
        }

        async function mostrarModal() {
    var resultadoValidacion = await validarDatos();

    // Oculta cualquier modal que esté visible actualmente
    

    if (resultadoValidacion !== undefined) {
        if (resultadoValidacion) {
            Swal.fire({
                icon: 'success',
                title: 'Datos guardados',
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: (resultadoValidacion === false) ? 'Completa correctamente los campos' : 'Nombre de usuario en uso',
            });
        }
    }
}
    // Agregar eventos input a los campos newPassword y confirmPass
    document.getElementById('newPassword').addEventListener('input', validarContraseñas);
    document.getElementById('confirmPass').addEventListener('input', validarContraseñas);


    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script type="text/javascript" src="../js/PantallaActualizarDatosScript.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha384-J6qa4849blEEN+R6O5enYsK2YbHaNU6K1cOPZ5f8+9R5ZBZ5lF06tLhN6sBoZl" crossorigin="anonymous"></script>

    <script>

        // Función para manejar la subida de la imagen con fetch
const cambiarImagen = async (event) => {
    try {
        const fileInput = event.target;
        const file = fileInput.files[0];

        if (!file) {
            return;
        }

        const formData = new FormData();
        formData.append('avatar', file);

        const response = await fetch('/turistas/cambiarFoto', {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            const responseData = await response.json();
            console.log('Respuesta del servidor:', responseData);

        } else {
            console.error('Error al cambiar la foto de perfil');
        }
    } catch (error) {
        console.error('Error en la subida de la imagen:', error);
    }
};
    </script>

    <script>
        // Solicitud al servidor para obtener la información del turista
        fetch("/turistas/informacionPerfil")
            .then((response) => {
            if (!response.ok) {
                throw new Error("Error en la solicitud fetch: " + response.status);
            }
            return response.json();
            })
            .then((turistaInfo) => {
            console.log('Camino:' + turistaInfo.Foto)

            // Actualizar la imagen de perfil con la nueva ruta
            const profileImage = document.getElementById("view-new-upload-image");
            if (turistaInfo.Foto) {
                profileImage.src = turistaInfo.Foto.replace(/\\/g, '/')
            }
            })
            .catch((error) =>
            console.error("Error al obtener información del turista:", error)
            );
    </script>
</body>
</html>

<!--

                        <div class="col-12 center-items">
                            <input type="text" placeholder="Nueva contraseña" id="newPassword" class="form-control" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="2.25rem" height="2.25rem" fill="currentColor" id="svg3" class="bi bi-pencil-square" viewBox="0 0 16 16" onclick="enabledNuevaContraseña()">
                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                            </svg>
                        </div>
                        <div class="col-12 center-items">
                            <input type="text" placeholder="Confirmar contraseña" id="confirmPass" class="form-control edit" disabled>
                        </div>-->