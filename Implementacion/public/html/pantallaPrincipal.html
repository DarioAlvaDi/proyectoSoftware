<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
      https-equiv="Content-Security-Policy"
      content="script-src 'self' https://unpkg.com;  https://www.overpass-api.de;"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      #map {
        height: 100vh;
      }
    </style>
    <!-- Bootstrap CSS library -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles/pantallaPrincipal.css"
    />

    <!-- JavaScript libraries -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.js"></script>
    <script src="../js/bootstrap.js"></script>
    <script
      async
      src="https://maps.googleapis.com/maps/api/js?key=&libraries=places&callback=initAutocomplete"
    ></script>
    <title>Beyamaps</title>
  </head>

  <body>
    <header class="header">
      <!--Barra de navegacion-->
      <nav class="navbar navColor">
        <div class="container-fluid">
          <a
            href="#"
            class="navbar-brand"
            data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasRight"
            aria-controls="offcanvasRight"
          >
            <img src="../imgs/Menu.png" alt="menu" />
          </a>

          <form action="" class="d-flex" role="search">
            <input
              type="text"
              id="autocomplete"
              class="form-control me-2"
              placeholder="Search"
              aria-label="Search"
            />
            <button class="btn" type="submit">
              <img src="../imgs/Lupa.png" alt="busqueda" />
            </button>
          </form>
        </div>
      </nav>
    </header>

    <!--Menu de opciones-->
    <div
      class="offcanvas offcanvas-start bg-transparent-1"
      tabindex="-1"
      id="offcanvasRight"
      aria-labelledby="offcanvasRightLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title text-center titulo" id="offcanvasRightLabel">
          Menú de Opciones
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <!--Menu de opciones-->
        <div
          class="container d-flex flex-column justify-content-center align-items-center"
        >
          <div class="row m-3">
            <div class="col">
              <!---La foto ira al lado izquierdo del texto en un mismo renglon-->
              <div class="d-inline-flex align-items-center">
                <img
                  src="../imgs/Perfil.png"
                  class="img-fluid me-4"
                  alt="fotoDePefil"
                />
                <a
                  href="/turistas/perfil"
                  class="fs-5 fw-semibold link-underline link-underline-opacity-0 link-dark"
                  >Mi perfil</a
                >
              </div>
            </div>
          </div>

          <div class="row m-3">
            <div class="col">
              <!---La foto ira al lado izquierdo del texto en un mismo renglon-->
              <div class="d-inline-flex align-items-center">
                <img
                  src="../imgs/Favoritos.png"
                  class="img-fluid me-4"
                  alt="Favoritos"
                />
                <a
                  href="/turistas/favoritos"
                  class="fs-5 fw-semibold link-underline link-underline-opacity-0 link-dark"
                  >Favoritos</a
                >
              </div>
            </div>
          </div>

          <div class="row m-3">
            <div class="col">
              <!---La foto ira al lado izquierdo del texto en un mismo renglon-->
              <div class="d-inline-flex align-items-center">
                <img
                  src="../imgs/Itinerario.png"
                  class="img-fluid me-4"
                  alt="Itinerario"
                />
                <a
                  href="/turistas/itinerario"
                  class="fs-5 fw-semibold link-underline link-underline-opacity-0 link-dark"
                  >Itinerarios</a
                >
              </div>
            </div>
          </div>

          <div class="row m-3">
            <div class="d-inline-flex">
              <div class="col">
                <!---La foto ira al lado izquierdo del texto en un mismo renglon-->
                <img
                  src="../imgs/Busqueda.png"
                  class="img-fluid"
                  alt="Busqueda"
                />
              </div>
              <div class="col">
                <label for="rangoBusqueda" class="form-label fw-semibold"
                  >Distancia de búsqueda</label
                >
                <input
                  type="text"
                  class="form-control busquedaColor"
                  id="rangoBusqueda"
                  placeholder="10 Km"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div id="map"></div>
    </div>

    <!-- Scripts para Leaflet y mapa -->
    <script>
      var map = L.map("map").setView([0, 0], 2);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(map);

      navigator.geolocation.getCurrentPosition(function (position) {
        var userLat = position.coords.latitude;
        var userLng = position.coords.longitude;

        var userMarker = L.marker([userLat, userLng], {
          icon: L.divIcon({
            className: "leaflet-div-icon",
            html: '<div style="background-color: red; width: 10px; height: 10px;"></div>'
          })
        })
          .addTo(map)
          .bindPopup("¡Tu ubicación!");

        map.setView([userLat, userLng], 13);

        var radius = 10000; // 10 km

        var museumsLayer = new L.GeoJSON.AJAX(
          "https://www.overpass-api.de/api/interpreter?data=[out:json];node(around:" +
            radius +
            "," +
            userLat +
            "," +
            userLng +
            ')["tourism"="museum"];out;',
          {
            onEachFeature: function (feature, layer) {
              layer.bindPopup(feature.properties.tags.name || "Unnamed");
            },
            pointToLayer: function (feature, latlng) {
              return L.marker(latlng, {
                icon: L.divIcon({
                  className: "leaflet-div-icon",
                  html: '<div style="background-color: blue; width: 10px; height: 10px;"></div>'
                })
              });
            }
          }
        ).addTo(map);

        var ubi = new google.maps.LatLng(userLat, userLng);
        var request = {
          location: ubi,
          radius: "2000",
          type: ["gym"]
        };
        var request2 = {
          location: ubi,
          radius: "2000",
          type: ["restaurant"]
        };

        service = new google.maps.places.PlacesService(
          document.createElement("div")
        );
        service.nearbySearch(request, callback);
        service.nearbySearch(request2, callback);
        function callback(results, status) {
          if (status == google.maps.places.PlacesServiceStatus.OK) {
            for (var i = 0; i < results.length; i++) {
              var place = results[i];
              var marcador = L.marker([
                place.geometry.location.lat(),
                place.geometry.location.lng()
              ]).addTo(map);
              marcador
                .bindPopup(
                  "<a href=/turistas/detalles?id=" +
                    place.place_id +
                    ">" +
                    place.name +
                    "</a>"
                )
                .openPopup();
            }
          }
        }
      });
      //locationBiaslocationBiaslocationBiaslocationBiaslocationBias
      let autocomplete;
      function initAutocomplete() {
        autocomplete = new google.maps.places.Autocomplete(
          document.getElementById("autocomplete"),
          {
            types: ["establishment"],
            fields: ["place_id", "geometry", "name"],
            componentRestrictions: { country: ["mx"] }
          }
        );
        autocomplete.addListener("place_changed", onPlaceChanged);
      }
      function onPlaceChanged() {
        var place = autocomplete.getPlace();
        if (!place.geometry) {
        } else {
          console.log(place.name, place.place_id);
          console.log(
            place.geometry.location.lat(),
            place.geometry.location.lng()
          );

          var marcador = L.marker([
            place.geometry.location.lat(),
            place.geometry.location.lng()
          ]).addTo(map);
          marcador
            .bindPopup(
              "<a href=/turistas/detalles?id=" +
                place.place_id +
                ">" +
                place.name +
                "</a>"
            )
            .openPopup();
          map.setView(
            [place.geometry.location.lat(), place.geometry.location.lng()],
            13
          );
        }
      }

      fetch("/turistas/consultarPreferencias")
        .then(function (response) {
          return response.json();
        })
        .then(function (myJson) {
          console.log(myJson);
          historial = myJson;
          /*Prototipo para que si el historial no tiene lugares aparezca el mensaje de que esta vacio en caso contrario que aparezcan los lugares del historial*/
          const historialElement = document.getElementById("historial");
          historialElement.innerHTML = ""; // Limpiar el contenido anterior
          let num = 0;
          historial.forEach((item) => {
            console.log(item);
            service = new google.maps.places.PlacesService(
              document.createElement("div")
            );
            var request = {
              placeId: item.Id_google,
              language: "es",
              fields: ["name", "photo"]
            };

            service.getDetails(request, callback);
            function callback(place, status) {
              if (status == google.maps.places.PlacesServiceStatus.OK) {
                let nombreLugar = place.name;
                let nuevoElemento = document.createElement("div");
                nuevoElemento.classList.add("resize");
                nuevoElemento.id = item.Id_Historial;

                nuevoElemento.innerHTML =
                  `
    <div class="container rounded-pill border border-3 border-dark p-3 contenedorSitio">
        <div class="row">
            <div class="col text-center">
                <img src="` +
                  place.photos[0].getUrl({ maxWidth: 335, maxHeight: 400 }) +
                  `" alt="busqueda" style="width:50%; height: 6rem">
            </div>
            <div class="col">
                <div class="row text-center">
                    <div class="col">
                        <p class="fw-bold nameSitio">` +
                  nombreLugar +
                  `</p>
                        <button class="detalles" onclick="window.location.href = '../PantallaActualizarDatos/PantallaActulizarDatos.html'">Detalles</button>
                    </div>
                    <div class="col-3">
                    <button id="eliminar` +
                  num +
                  `" onclick="eliminar(` +
                  item.Id_Historial +
                  `)" class="boton-redondo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="red" class="bi bi-x-circle-fill eliminar" viewBox="0 0 16 16" style="margin-top:25%">
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
                    </svg>
                    </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    `;
                document.getElementById("historial").appendChild(nuevoElemento);
                num++;
              }
            }
          });
        });
    </script>
  </body>
</html>
